# All_timer

### 时间堆的改进

**问题:** 

目前发现调整目标定时器(连接活跃, 要延长时间)不方便, 采用顺序查找, 再做下坠处理, 复杂度为**O(n)**, 如果频繁需要调整, 则大部分时间花在查找上

**故做如下更改:**

    1. 在 heap_timer 类中添加一个 bool 成员 is_valid, 用于判断定时器是否被更改。
    2. 需要更改的定时器, 先置标志位为 false 再调用 add_timer 成员函数在堆中插入一个新的定时器。
    3. 对于以上设计上的改进, 在更改定时器的工作函数中, 新建一个 heap_timer, 更改用户数据结构持有的 heap_timer指针, 再将新的 heap_timer加入堆中。另外对于心跳函数 tick() 稍作修改, 加入判断堆顶元素的 is_valid 标志, 为false的则直接执行 pop_timer() 操作。
    4. 堆的 del_timer() 成员函数原本设计为将目标定时器的回调函数设置为空, 现在可以将标志位置 false, 同样为延迟销毁。

**说明:**

在 heap_timer 类中添加标志位是便于理解和使用的做法, 如果对内存有极致要求, 则可以将标志位 is_valid 用该类中的 回调函数指针成员 cb_func 代替。当定时器更改或要删除时置为 NULL


致谢 《linux高性能服务器编程》 游双
